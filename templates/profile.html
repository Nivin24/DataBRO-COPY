<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Profile</title>
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
    <style>
        /* :root {
        
        --logo-title-color: #14213d;
        --card-border-color: #ddd;
        --background-color:wheat;
        --text-color: #000;
        --toogle-color: #071019;
        --card-bg-color: #fff;
        --card-border-color: #ddd;
        --card-shadow-color: rgba(0, 0, 0, 0.1);
    }
    [data-theme="dark"] {
        
        --logo-title-color: #fff;
        --card-border-color: #2c1d50;
        --background-color:rgba(21, 26, 80, 0.769);
        --text-color: #fff;
        --toogle-color: #071019;
        --card-bg-color: #271b43;
        --card-border-color: #2c1d50;
        --card-shadow-color: rgba(0, 0, 0, 0.5);
    } */
    /* body { 
      background-color: var(--bg-color);
      background-image: var(--bg-gradient, none);
      color: var(--text-color);
       
      font-family: Arial, Helvetica, sans-serif; 
    } */
        :root {
            --bg-gradient: linear-gradient(135deg, #f9f9f9 0%, #c3e0f5 100%);
            --text-color: #000;
            --card-bg-color: rgb(255, 255, 255);
            --card-border-color: #ddd;
            --card-shadow-color: rgba(0, 0, 0, 0.1);
            --gradient-hover: linear-gradient(145deg, #d6eaff, #ffffff);
            --icon-bg-color: #0051ffd8;
            --icon-box-color: #2041e7;
            --icon-color: #fff;
            --icon-hover-bg-color: #0056b3;
            --icon-hover-color: #fff;
            --icon-hover-border-color: #004494;
        }
        [data-theme="dark"] {
            --bg-gradient: linear-gradient(135deg, #100a1b, #271b43);
            --text-color: #fff;
            --card-bg-color: #271b43;
            --card-border-color: #2c1d50;
            --card-shadow-color: rgba(0, 0, 0, 0.5);
            --gradient-hover: linear-gradient(145deg, #271b43, #200e49);
            --icon-bg-color: #4e23c3;
            --icon-box-color: rgba(44, 16, 95, 0.9);
            backdrop-filter: blur(12px);
            --icon-color: #fff;
            --icon-hover-bg-color: #5f41af;
            --icon-hover-color: #fff;
            --icon-hover-border-color: #3e1f8b;
        }
        body, h1, h2, p, a {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        h1, h2, p{
            color: var(--text-color);
        }
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            background: var(--bg-gradient);
            transition: background-color 0.3s ease, color 0.3s ease;
            color: var(--text-color);
        }
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--icon-bg-color);
            color: var(--icon-color);
            padding: 1rem 2rem;
        }
        nav .logo h2 {
            margin: 0;
        }
        nav .nav-links a {
            color: var(--icon-color);
            text-decoration: none;
            margin-left: 1.5rem;
            font-weight: bold;
            transition: transform 0.2s ease;
        }
        #home {
            color: var(--icon-color);
            text-decoration: none;
            font-weight: bold;
            transition: transform 0.2s ease;
        }
        #home:hover{
            transform: scale(1.05);
        }
        .container {
            max-width: 900px;
            margin: 2rem auto;
            background: var(--card-bg-color);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--card-shadow-color);
            border: 1px solid var(--card-border-color);
        }
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }
        .profile-header img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            margin-right: 1.5rem;
            object-fit: cover;
        }
        .profile-header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        .profile-header p {
            color: #666;
        }
        .btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            background-color: var(--icon-bg-color);
            color: var(--icon-color);
            text-decoration: none;
            border-radius: 4px;
            margin-top: 1rem;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: var(--icon-hover-bg-color);
        }
        hr {
            border: 0;
            height: 1px;
            background: var(--card-border-color);
            margin: 2rem 0;
        }
        .section {
            margin-bottom: 2rem;
        }
        .skills, .social-links {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .skill, .social-link {
            background: var(--gradient-hover);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 3px var(--card-shadow-color);
        }
        .social-link a {
            color: var(--icon-bg-color);
            text-decoration: none;
        }
        .social-link a:hover {
            text-decoration: underline;
        }
        .theme-toggle-btn {
            background: var(--icon-box-color);
            color: var(--icon-color);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            margin-left: 1rem;
            font-size: 1.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .theme-toggle-btn:hover {
            background: var(--icon-hover-bg-color);
        }
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                text-align: center;
            }
            nav .nav-links {
                margin-top: 1rem;
            }
            nav .nav-links a {
                margin: 0.5rem 0;
            }
            .profile-header {
                flex-direction: column;
                text-align: center;
            }
            .profile-header img {
                margin-bottom: 1rem;
            }
        }
        /* Activity Heatmap */
        .heatmap {
            display: grid;
            grid-template-rows: repeat(7, 12px);
            grid-auto-flow: column;
            grid-auto-columns: 12px;
            column-gap: 4px;
            row-gap: 2px;
            margin-top: 10px;
        }
        /*.day-box {
            width: 12px;
            height: 12px;
            background-color: #eee;
            border-radius: 2px;
            transition: background-color 0.3s ease;
        }
        .day-box.active {
            background-color: #1df900;
        }
        /* Activity Heatmap */
        .month-spacer {
            width: 4px;
            background: transparent;
        }
        #heatmap-labels {
            width: 70vw;
            display: flex;
            column-gap: 80px;
            margin-bottom: 6px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-color);
        } 
        .badge-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .badge {
            text-align: center;
            width: 100px;
            
        }
        .badge img {
            width: 60px;
            height: 60px;
            object-fit: contain;
            background-color: #fff;
            padding: 3px;
            border-radius: 40%;
            box-shadow: 0 1px 3px var(--card-shadow-color);
        }
        .badge p {
            font-size: 12px;
            margin-top: 0.5rem;
            color: var(--text-color);
        }
        .badge-popup {
          position: fixed;
          top: 0; left: 0;
          width: 100%; height: 100%;
          display: flex;
          justify-content: center;
          align-items: center;
          background: rgba(0,0,0,0.4);
          z-index: 9999;
          pointer-events: none;
          opacity: 0;
          transition: opacity 0.4s ease;
        }
        .badge-popup.show {
          pointer-events: all;
          opacity: 1;
        }
        .badge-popup .popup-content {
          background: #ffffff1f;
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          animation: scaleIn 0.4s ease;
          box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
          max-width: 80%;
        }
        .popup-content img {
          width: 80px;
          height: auto;
          border-radius: 15px;
          margin-bottom: 10px;
        }
        @keyframes scaleIn {
          from {
            transform: scale(0.7);
            opacity: 0;
          }
          to {
            transform: scale(1);
            opacity: 1;
          }
        }

        /* .day-box {
            position: relative;
        }
                @media (max-width: 600px) {
          .popup-content img {
            width: 64px;
          }
          .popup-content p {
            font-size: 14px;
          }
        }

        .day-box .tooltip {
            visibility: hidden;
            width: max-content;
            max-width: 200px;
            background-color: var(--tooltip-bg, #333);
            color: var(--tooltip-text, #fff);
            text-align: center;
            border-radius: 4px;
            padding: 4px 8px;
            position: absolute;
            z-index: 1; */
            /* bottom: 125%; Show above the box */
            /* left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 10px;
            white-space: nowrap;
        }

        .day-box:hover .tooltip {
            visibility: visible;
            opacity: 1;
        } */
        .motive-home {
            color: var(--logo-title-color, #14213d);
            transition: color 0.3s;
        }
        :root {
            --logo-title-color: #b31cc7;
        }
        [data-theme="dark"] {
            --logo-title-color: #e4ec08;
        }
        #popup-badge-msg {
        font-family: monospace;
        font-size: 18px;
        white-space: nowrap;
        overflow: hidden;
        border-right: 2px solid orange;
        width: 0;
        }

        /* Typewriter effect */
        .typing {
        animation: typing 3s steps(40, end), blink 0.7s step-end infinite;
        }

        /* Final state to freeze the message */
        .frozen {
        animation: none;
        border-right: none;
        width: auto;
        }

        @keyframes typing {
        from { width: 0 }
        to { width: 40ch } /* adjust based on character count */
        }

        @keyframes blink {
        50% { border-color: transparent }
        }


        /* New css for heatmap and label*/
        /* Container */
        #heatmap-label-and-boxes {
        overflow-x: auto;
        padding: 10px;
        box-sizing: border-box;
        -webkit-overflow-scrolling: touch;
        }

        /* This wraps both labels and heatmap and scrolls together */
        #heatmap-scroll-wrapper {
        display: flex;
        flex-direction: column;
        min-width: max-content; /* Ensure horizontal scroll works */
        }

        /* Month labels at top, horizontally aligned */
        #heatmap-labels {
        display: grid;
        grid-auto-flow: column;
        grid-auto-columns: 12px;
        margin-bottom: 6px;
        font-size: 10px;
        font-weight: bold;
        color: var(--text-color);
        }

        /* Grid of boxes: 7 rows (Sun to Sat), columns per day */
        .heatmap {
        display: grid;
        grid-template-rows: repeat(7, 12px);
        grid-auto-flow: column;
        grid-auto-columns: 12px;
        column-gap: 4px;
        row-gap: 2px;
        }

        /* Each box = 1 day */
        .day-box {
        width: 12px;
        height: 12px;
        background-color: #aaa7a7c7;
        border-radius: 2px;
        position: relative;
        transition: background-color 0.3s ease;
        }

        /* Active state */
        .day-box.active {
        background-color: #20d408;
        }

        /* Tooltip */
        .day-box .tooltip {
        visibility: hidden;
        background-color: var(--tooltip-bg, #333);
        color: var(--tooltip-text, #fff);
        text-align: center;
        border-radius: 4px;
        padding: 4px 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.2s ease;
        font-size: 10px;
        white-space: nowrap;
        max-width: 200px;
        }
        .day-box:hover .tooltip {
        visibility: visible;
        opacity: 1;
        }

        /* Spacer between months */
        .month-spacer {
        width: 4px;
        background: transparent;
        }

        /* Mobile: adjust tooltip and image sizes if used */
        @media (max-width: 600px) {
        .popup-content img {
            width: 64px;
        }
        .popup-content p {
            font-size: 14px;
        }
        }
    </style>
</head>
<body>
    <nav style="display: flex;">
        <div class="logo">
            <a href="{{ url_for('home.home') }}" style="text-decoration: none;">
                <img src="{{ url_for('static', filename='databro.png') }}" alt="DataBRO Logo" style="height:40px; border-radius: 30%; vertical-align:middle; margin-right:10px;">
                <h2 style="display:inline; vertical-align:middle; color: #fff;">DataBRO</h2>
            </a>
        </div>
        <div class="nav-links" style="display: flex; align-items: center; gap: 1rem;">
            <a id="home" href="{{ url_for('home.home') }}" style="transition: transform 0.2s;" title="Home">
            <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 -960 960 960" width="32px" fill="#FFFFFF"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z"/></svg>
            </a>
            <a id="home" href="{{ url_for('settings.settings') }}" style="transition: transform 0.2s;" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 -960 960 960" width="32px" fill="#FFFFFF"><path d="m370-80-16-128q-13-5-24.5-12T307-235l-119 50L78-375l103-78q-1-7-1-13.5v-27q0-6.5 1-13.5L78-585l110-190 119 50q11-8 23-15t24-12l16-128h220l16 128q13 5 24.5 12t22.5 15l119-50 110 190-103 78q1 7 1 13.5v27q0 6.5-2 13.5l103 78-110 190-118-50q-11 8-23 15t-24 12L590-80H370Zm70-80h79l14-106q31-8 57.5-23.5T639-327l99 41 39-68-86-65q5-14 7-29.5t2-31.5q0-16-2-31.5t-7-29.5l86-65-39-68-99 42q-22-23-48.5-38.5T533-694l-13-106h-79l-14 106q-31 8-57.5 23.5T321-633l-99-41-39 68 86 64q-5 15-7 30t-2 32q0 16 2 31t7 30l-86 65 39 68 99-42q22 23 48.5 38.5T427-266l13 106Zm42-180q58 0 99-41t41-99q0-58-41-99t-99-41q-59 0-99.5 41T342-480q0 58 40.5 99t99.5 41Zm-2-140Z"/></svg>
            </a>
            <form action="{{ url_for('login.logout') }}" method="post" style="display: inline; margin-left: 20px;" title="Logout">
            <button id="home" type="submit" style="background: none; border: none; color: #fff; text-decoration: none; cursor: pointer; font-weight: bold;">
                <svg xmlns="http://www.w3.org/2000/svg" height="32px" viewBox="0 -960 960 960" width="32px" fill="#FFFFFF"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h280v80H200v560h280v80H200Zm440-160-55-58 102-102H360v-80h327L585-622l55-58 200 200-200 200Z"/></svg>
            </button>
            </form>
            <button class="theme-toggle-btn" id="theme-toggle" title="Toggle theme">&#9788;</button>
        </div>
    </nav>

    <div class="container">
        <div class="profile-header">
            <img src="{{ user.picture if user and 'picture' in user else url_for('static', filename='default-profile.png') }}" alt="User Picture" class="profile-picture">
            <div>
                <h1>Welcome, {{ user['name'] if user and 'name' in user else 'Guest' }}!</h1>
                <p><strong>Email:</strong> {{ user['email'] if user and 'email' in user else 'Not provided' }}</p>
                <p><strong>Member since:</strong> {{ user['signup_date'].strftime('%B %d, %Y') if user and 'signup_date' in user else 'Unknown' }}</p>
            </div>
        </div>

        <hr>

        <div class="section">
            <h2>Motivation</h2>
            {% if user and 'skills' in user and user['skills'] %}
            <p style="text-shadow: 0 0 8px rgba(255, 255, 255, 0.8); color: var(--icon-color); text-decoration: none;">
                You have mastered {{ user['skills']|length }} skill{{ 's' if user['skills']|length > 1 else '' }} so far! Keep pushing forward to achieve mastery in all topics from the <a class="motive-home" href="{{ url_for('home.home') }}" style=" text-decoration: none; pointer-events: none;">Home Page</a>.
            </p>
            {% else %}
            <p>You haven't added any skills yet. Start your journey by exploring the <a class="motive-home" href="{{ url_for('home.home') }}" style="text-decoration: none; pointer-events:fill; color: var(--logo-title-color);">Home Page</a> and mastering your first skill!</p>
            {% endif %}
        </div>

        <div class="section">
            <h2>Skills</h2>
            <div class="skills">
                {% if user and 'skills' in user and user['skills'] %}
                    {% for skill in user['skills'] %}
                        <div class="skill">{{ skill }}</div>
                    {% endfor %}
                {% else %}
                    <div class="skill">Python</div>
                    <div class="skill">Example: Python (complete a skill to see it here!)</div>
                {% endif %}
            </div>
        </div>

        <div class="section" id="htmp">
            <!-- <h2>Recent Activity</h2>
            <ul>
                {% for activity in user['recent_activity'] if user and 'recent_activity' in user %}
                    <li>{{ activity }}</li>
                {% endfor %}
            </ul> -->
            <h2 style="margin-top: 30px; margin-bottom: 20px;">Your Activity (Last 6 Months)</h2>
            <div style="display: flex;">
                <div style="display: grid; grid-template-rows: repeat(7, 12px); row-gap: 2px; margin-right: 6px;">
                    <div style="font-size: 10px; color: var(--text-color); line-height: 95px;">Sun</div>
                    <div style="font-size: 10px; color: var(--text-color); line-height: 95px;">Mon</div>
                    <div style="font-size: 10px; color: var(--text-color); line-height: 95px;">Tue</div>
                    <div style="font-size: 10px; color: var(--text-color); line-height: 95px;">Wed</div>
                    <div style="font-size: 10px; color: var(--text-color); line-height: 95px;">Thu</div>
                    <div style="font-size: 10px; color: var(--text-color); line-height: 95px;">Fri</div>
                    <div style="font-size: 10px; color: var(--text-color); line-height: 95px;">Sat</div>
                </div>
                <!-- <div id="heatmap-label-and-boxes">
                    <div id="heatmap-labels" style="margin-right: 30px;"></div>
                    <div id="heatmap" class="heatmap-grid"></div>
                </div> -->
                <div id="heatmap-label-and-boxes">
                    <div id="heatmap-scroll-wrapper">
                        <div id="heatmap-labels" ></div>
                        <div id="heatmap" class="heatmap"></div>
                    </div>
                </div>
                <!-- <style>
                    #heatmap-label-and-boxes {
                    display: flex;
                    flex-wrap: nowrap;
                    overflow-x: auto;
                    overflow-y: hidden;
                    max-width: 100%;
                    -webkit-overflow-scrolling: touch; Smooth scrolling on iOS
                    gap: 10px; space between items
                    padding: 10px;
                    box-sizing: border-box;
                    scrollbar-width: thin; Firefox
                    }

                    Optional: Style scrollbar (Webkit only)
                    #heatmap-label-and-boxes::-webkit-scrollbar {
                    height: 6px;
                    }
                    #heatmap-label-and-boxes::-webkit-scrollbar-thumb {
                    background-color: rgba(0, 0, 0, 0.3);
                    border-radius: 3px;
                    }
                </style> -->
            </div>
            <p style="margin-top: 20px;"><strong>Total Active Days: </strong> <span id="active-count">0</span></p>
            <p style="margin-top: 10px;"> <strong>Current Streak ðŸ”¥: </strong> <span id="streak-count">0</span> days</p>
            <p style="margin-top: 10px;"> <strong>Longest Streak ðŸ”¥: </strong> <span id="longest_streak">0</span> days</p>
        </div>

        <div class="section">
            <h2>Achievement Badges</h2>
            <div class="badge-grid">
                {% set earned = user['badges'] if user and 'badges' in user else [] %}
                <!-- 30-Day Streak Badge -->
                {% if '30days' in earned %}
                    <div class="badge">
                        <img src="{{ url_for('static', filename='images/30DaysCount.png') }}" alt="30-Day Streak">
                        <p>30-Day Streak</p>
                    </div>
                {% else %}
                    <div class="badge">
                        <img src="{{ url_for('static', filename='images/30Days-Grey.png') }}" alt="30-Day Streak (Locked)">
                        <p>30-Day Streak</p>
                        <p id="progress-30">Progress: --/30 days</p>
                        <div style="background:#eee; border-radius:4px; height:7px; margin:4px 0;">
                            <div id="bar-30" style="background:#2ab308; height:100%; width:0%; border-radius:4px;"></div>
                        </div>
                    </div>
                {% endif %}
                <!-- 50 Active Days Badge -->
                {% if '50days' in earned %}
                    <div class="badge">
                        <img src="{{ url_for('static', filename='images/50Days.png') }}" alt="50 Active Days">
                        <p>50 Active Days</p>
                    </div>
                {% else %}
                    <div class="badge">
                        <img src="{{ url_for('static', filename='images/50Days-Grey.png') }}" alt="50 Active Days (Locked)">
                        <p>50 Active Days</p>
                        <p id="progress-50">Progress: --/50 days</p>
                        <div style="background:#eee; border-radius:4px; height:7px; margin:4px 0;">
                            <div id="bar-50" style="background:#2ab308; height:100%; width:0%; border-radius:4px;"></div>
                        </div>
                    </div>
                {% endif %}
                <!-- 100 Active Days Badge -->
                {% if '100days' in earned %}
                    <div class="badge">
                        <img src="{{ url_for('static', filename='images/100Days.png') }}" alt="100 Active Days">
                        <p>100 Active Days</p>
                    </div>
                {% else %}
                    <div class="badge">
                        <img src="{{ url_for('static', filename='images/100Days-Grey.png') }}" alt="100 Active Days (Locked)">
                        <p>100 Active Days</p>
                        <p id="progress-100">Progress: --/100 days</p>
                        <div style="background:#eee; border-radius:4px; height:7px; margin:4px 0;">
                            <div id="bar-100" style="background:#2ab308; height:100%; width:0%; border-radius:4px;"></div>
                        </div>
                    </div>
                {% endif %}
                <!-- Full Month Activity Badge -->
                {% if 'full-month' in earned %}
                    <div class="badge">
                        <img src="{{ url_for('static', filename='images/full-month.png') }}" alt="Full Month Activity">
                        <p>Full Month Activity</p>
                    </div>
                {% else %}
                    <div class="badge">
                        <img id="month-badge-img" src="{{ url_for('static', filename='images/4.png') }}" alt="Full Month Activity (Locked)">
                        <p>Full Month Activity</p>
                        <p id="month-progress-text">Keep going!</p>
                        <div style="background:#eee; border-radius:4px; height:7px; margin:4px 0;">
                            <div id="month-bar" style="background:#2ab308; height:100%; width:0%; border-radius:4px;"></div>
                        </div>
                    </div>
                {% endif %}
                {% if not earned or earned|length == 0 %}
                    <p>No badges earned yet. Keep going!</p>
                {% endif %}
            </div>
        </div>

        <a href="#" class="btn">Edit Profile</a>
    </div>
    <!-- Badge Unlock Popup -->
    <div id="badge-unlock-popup" class="badge-popup hidden">
      <div class="popup-content">
        <img id="popup-badge-img" src="" alt="Unlocked Badge" style="border-radius: 15px;">
        <p id="popup-badge-msg"></p>
      </div>
    </div>
    <script>
        // Theme persistence and toggle
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            document.getElementById('theme-toggle').innerHTML = theme === 'dark' ? '&#9790;' : '&#9788;';
        }
        // On load, set theme from localStorage or default
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
        })();
        // Toggle button
        document.getElementById('theme-toggle').addEventListener('click', function() {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        });
    </script>
    <script>
        // Toggle to enable UTC-based date generation for heatmap
        const useUTCForHeatmap = true;

        function getLast180DaysInGrid() {
            const days = [];
            if (useUTCForHeatmap) {
                const now = new Date();
                const today = new Date(Date.UTC(
                    now.getUTCFullYear(),
                    now.getUTCMonth(),
                    now.getUTCDate()
                ));
                for (let i = 179; i >= 0; i--) {
                    const date = new Date(today);
                    date.setUTCDate(today.getUTCDate() - i);
                    const iso = date.toISOString().slice(0, 10);
                    if (days.length < 180) days.push(iso);  // Ensures exactly 180 boxes
                }

            } 
            // else {
            //     // Original local-time version
            //     const today = new Date();
            //     for (let i = 179; i >= 0; i--) {
            //         const date = new Date(today);
            //         date.setDate(today.getDate() - i);
            //         days.push(date.toISOString().slice(0, 10));
            //     }
            // }
            return days;
        }

        fetch('/api/activity-data')
            .then(res => res.json())
            .then(data => {
                const heatmap = document.getElementById('heatmap');
                const labelContainer = document.getElementById('heatmap-labels');
                const activeDates = new Set(data.dates.map(d => d.slice(0, 10)));
                const days = getLast180DaysInGrid();

                heatmap.innerHTML = "";
                labelContainer.innerHTML = "";

                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                let lastMonth = new Date(days[0]).getMonth();

                let columnCount = 0;

                days.forEach((d, index) => {
                const date = new Date(d);
                const currentMonth = date.getMonth();
                const weekday = date.getDay();

                if (index === 0 || currentMonth !== lastMonth) {
                    const label = document.createElement('div');
                    label.textContent = monthNames[currentMonth];
                    label.style.width = '12px';
                    label.style.textAlign = 'center';
                    label.style.fontSize = '10px';
                    label.style.fontWeight = 'bold';
                    label.style.color = 'var(--text-color)';
                    labelContainer.appendChild(label);

                    if (index !== 0) {
                        const spacer = document.createElement('div');
                        spacer.className = 'month-spacer';
                        spacer.style.gridRow = '1 / span 7';
                        heatmap.appendChild(spacer);
                    }

                    for (let i = 0; i < weekday; i++) {
                        const emptyBox = document.createElement('div');
                        emptyBox.className = 'day-box';
                        emptyBox.style.visibility = 'hidden';
                        heatmap.appendChild(emptyBox);
                    }
                }

                const box = document.createElement('div');
                box.className = 'day-box';

                if (d === new Date().toISOString().slice(0, 10)) {
                    console.log("Today:", d, "Active:", activeDates.has(d));
                }

                if (activeDates.has(d)) {
                    box.classList.add('active');
                }

                const isActive = activeDates.has(d);
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.textContent = `${new Date(d).toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' })} â€” ${isActive ? "âœ… Active" : "â¬œ Inactive"}`;
                box.appendChild(tooltip);
                heatmap.appendChild(box);

                lastMonth = currentMonth;
            });

            document.getElementById('active-count').textContent = data.total_days;
            // Fetch streak data and update streak count and badge progress
            fetch('/api/badge-progress')
                .then(res => res.json())
                .then(data => {
                    function animateCountUp(element, endValue, duration = 1000) {
                        let start = 0;
                        const step = Math.ceil(endValue / (duration / 50));
                        const interval = setInterval(() => {
                            start += step;
                            if (start >= endValue) {
                                start = endValue;
                                clearInterval(interval);
                            }
                            element.textContent = start;
                        }, 50);
                    }
                    animateCountUp(document.getElementById('streak-count'), data.current_streak);

                    // Animate the longest streak
                    const longestStreakElement = document.getElementById('longest_streak');
                    if (longestStreakElement) {
                        animateCountUp(longestStreakElement, data.longest_streak);
                    }

                    if (document.getElementById('progress-30')) {
                        document.getElementById('progress-30').textContent = `Progress: ${data.current_streak}/30 days`;
                        if (document.getElementById('bar-30')) {
                            let percent = Math.min(100, Math.round((data.current_streak / 30) * 100));
                            document.getElementById('bar-30').style.width = percent + '%';
                        }
                    }
                    if (document.getElementById('progress-50')) {
                        document.getElementById('progress-50').textContent = `Progress: ${data.total_active_days}/50 days`;
                        if (document.getElementById('bar-50')) {
                            let percent = Math.min(100, Math.round((data.total_active_days / 50) * 100));
                            document.getElementById('bar-50').style.width = percent + '%';
                        }
                    }
                    if (document.getElementById('progress-100')) {
                        document.getElementById('progress-100').textContent = `Progress: ${data.total_active_days}/100 days`;
                        if (document.getElementById('bar-100')) {
                            let percent = Math.min(100, Math.round((data.total_active_days / 100) * 100));
                            document.getElementById('bar-100').style.width = percent + '%';
                        }
                    }
                    updateMonthlyBadge(data);
                });
            });

            function getLastDayOfMonth(year, month) {
                return new Date(year, month + 1, 0).getDate();
            }

            function updateMonthlyBadge(data) {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth(); // 0-indexed
                const monthName = now.toLocaleString('default', { month: 'long' }).toLowerCase(); // e.g., 'may'
                const todayDate = now.getDate();
                const lastDay = getLastDayOfMonth(year, month);

                const streakDays = data.monthly_streak_days || 0;

                const progressTextEl = document.getElementById('month-progress-text');
                const progressBarEl = document.getElementById('month-bar');
                const badgeImgEl = document.getElementById('month-badge-img');

                // Reset: if user missed any day before today
                if (streakDays < todayDate - 1) {
                    progressTextEl.textContent = `Streak broken this month âŒ`;
                    progressBarEl.style.width = '0%';
                    progressBarEl.style.backgroundColor = 'red';
                    badgeImgEl.src = `/static/images/4.png`; // fallback badge
                    return;
                }

                // Progress
                const percent = Math.min(100, Math.round((streakDays / lastDay) * 100));
                progressTextEl.textContent = `Progress: ${streakDays}/${lastDay} days`;
                progressBarEl.style.width = `${percent}%`;

                // Badge unlock condition
                if (streakDays === lastDay) {
                    badgeImgEl.src = `/static/images/${monthName}.png`; // Replace with actual image name
                    progressTextEl.textContent = `âœ… Full streak!`;
                } else {
                    badgeImgEl.src = `/static/images/4.png`; // Default "in progress" image
                }
            }


            function showBadgePopup(badgeName, imageUrl) {
                const popup = document.getElementById('badge-unlock-popup');
                const img = document.getElementById('popup-badge-img');
                const msg = document.getElementById('popup-badge-msg');

                const fullText = `ðŸŽ‰ You unlocked the "${badgeName}" badge!`;
                img.src = imageUrl || 'default-badge.png';

                // Step 1: Set text content to full message
                msg.textContent = fullText;

                // Step 2: Trigger typing animation
                msg.classList.remove('typing');
                void msg.offsetWidth; // force reflow
                msg.classList.add('typing');

                // Step 3: Show the popup
                popup.classList.add('show');
                popup.classList.remove('hidden');

                // Step 4: After animation ends, replace message with full visible text
                setTimeout(() => {
                    msg.classList.remove('typing');
                    msg.style.width = 'auto';
                    msg.style.borderRight = 'none';
                    msg.textContent = fullText; // reset to ensure no partial characters
                }, 3000); // match CSS animation duration

                // Step 5: Hide popup after delay
                setTimeout(() => {
                    popup.classList.remove('show');
                    popup.classList.add('hidden');
                }, 6000); // 3s typing + 3s freeze
            }
            // Test call 1
            // showBadgePopup("30 Days", "/static/images/30DaysCount.png");

            // Test call 2
            // showBadgePopup("100 Days", "/static/images/100Days.png");

            // Test call 3
            // showBadgePopup("Full Month Streak", "/static/images/full-month.png");
    </script>
</body>
</html>